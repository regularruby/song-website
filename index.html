<html lang="en" style="background-color: black">

<head>
    <meta charset="utf-8">

    <title>music</title>
    <meta name="description" content="music">
    <meta name="author" content="SitePoint">
    <link rel="stylesheet" href="theme.css">

</head>

<body style="color:white">
    <table width="100%">
        <tr>
            <td id="ip" width="12.8%"></td>
            <td id="ping" style="padding-left: 10px"></td>
        </tr>
    </table>
    <table id="data" width="100%"></table>
    <audio controls preload="auto">
        <source src="song.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        $(function () {
            var socket = io();
            var ping;
            var pingStorage = [];
            var pingAvg;

            socket.on('link', address => {
                document.getElementById("ip").innerHTML = "ip address:\t" + address;
                console.log("link");
                socket.emit("fully linked");
            })

            socket.on('pingTime', time => {
                ping = Date.now() - time;
                pingStorage.push(ping);

                let avg = 0;
                for (i = 0; i < pingStorage.length; i++) {
                    avg += pingStorage[i];
                }
                pingAvg = Math.round(10 * (avg / pingStorage.length)) / 10000;

                if (pingStorage.length > 1000) {
                    pingStorage = [pingAvg]
                }

                document.getElementById("ping").innerHTML = "ping:\t" + pingAvg;
                socket.emit("avrage ping", pingAvg);
            })

            socket.on('data', users => {
                let str = "<tr><td>IP Address:</td><td>Ping(ms):</td><td>Client ID:</td><td width='70%'></td></tr>"
                users.forEach(user => {
                    if(user.addr == "localhost") return;
                    str = str.concat("<tr><td width: '10%'>" + user.addr + "</td><td width: '10%'>" + user.ping + "</td><td width: '10%'>" + user.id + "</td></tr>")
                });
                document.getElementById("data").innerHTML = str;
            })

        });
    </script>
</body>

</html>